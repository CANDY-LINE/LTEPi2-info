[🔙目次ページへ戻る](README.md)

# LTEPi for Dを上級者向け用途で使用するする場合のセットアップ【上級者向け】

[LTEPi for D](https://www.candy-line.io/製品一覧/ltepi-for-d/)の用途として、通常ではラズパイからインターネットのサーバーへLTE回線で接続するような使い方を想定されています。しかし、目的によっては、インターネットからLTE回線経由でラズパイに接続するような用途も存在します。
そのような用途においては、通常とは異なるセットアップを行います。

なお、この方法をお使いになる場合は、

- **ご利用者自身でLinuxファイアーウォール(`ufw`または`iptables`)の設定を適正にできること**
- **ご利用者自身がLinuxでのpppに関する知識をお持ちであること**

が必須となります。誤った設定を行うと、ラズパイにアクセスできなくなったり、ラズパイが不正なアクセスを受けたりするなどの危険がありますのでご注意ください。

この方式の利用については、**ご利用者自身の責任範囲において行ってください**。

## LTEPi for DのLTE通信動作方式

[LTEPi for D](https://www.candy-line.io/製品一覧/ltepi-for-d/)におけるLTE通信時の動作方式には、「ルーターモード」と「モデムモード」があります。
「ルーターモード」では、[LTEPi for D](https://www.candy-line.io/製品一覧/ltepi-for-d/)側の機器がラズパイとは独立したインターネット機器となり、ラズパイから見るとルーターとして振る舞うようになります。この場合は、[LTEPi for D](https://www.candy-line.io/製品一覧/ltepi-for-d/)側の機器がインターネットへの出入り口となりますから、ラズパイへ外部から直接接続することはできません。

一方、「モデムモード」を利用すると、[LTEPi for D](https://www.candy-line.io/製品一覧/ltepi-for-d/)側の機器は、ラズパイと一体となった通信機器のような振る舞いをします。この場合、ラズパイがLTEへ接続した時にパブリックIP（グローバルIP）がMVNO事業者のネットワークから割り当てられると、外部のネットワークからラズパイに直接接続することが可能となります。

|  標準  |    動作方式   | モデムデータ通信       | 外部からLTE経由で接続 |
|-------|--------------|---------------------|--------------------|
|  はい  | ルーターモード | ethernet/USB CDC ECM| 不可               |
| いいえ | モデムモード   | ppp/USB Serial      | 条件付きで可能       |

半面、「モデムモード」は「ルーターモード」よりも取り扱いが難しく、また、外部からアクセスできてしまうため、「ルーターモード」にはないセキュリティ上の脅威が発生します。インターネットからラズパイに直接アクセスする必要性があるような特殊な用途でのみ、ご利用を検討してください。
なお、ラズパイにパブリックIP（グローバルIP）が割当たるかどうかは、SIMのご契約先により異なります。不明な場合は、SIMのご契約先にお問い合わせください。

## 「モデムモード」でのセットアップ

「モデムモード」でセットアップするときは、以下のコマンドを実行します。`ROUTER_ENABLED=0`が「モデムモード」であることを示しています。`BOOT_APN`には、あらかじめ用意されているAPN設定を指定することができます。

```bash
$ curl -L https://git.io/vKyOf | sudo ROUTER_ENABLED=0 BOOT_APN=<apn名> bash
```

`<apn名>`には、現在以下の値を指定することができます。

- `lte-d.ocn.ne.jp`
- `iijmio.jp`
- `soracom.io`
- `umobile.jp`

指定しない時は、`umobile.jp`が選択されます。上記に存在しないAPNである場合は、インストール後に`candy`コマンドを使用して変更します。
詳しくは「[APNの設定](APNの設定.md)」をご覧ください。正しいAPNを指定した後は、**必ずラズパイ本体を再起動 してください。** 再起動しないままでは、正しく接続できないことがあります。

このコマンドにより、モデム関連では以下のパッケージがインストールされます。

- `ufw` ... ファイアーウォール
- `ppp` ... ppp関連
- `pppconfig` ... ppp設定ツール

**注意）すでに、「ルーターモード」のセットアップをしている場合は、「[ltepi2-serviceのアンインストール](アンインストール方法.md)」を行ってから、上記のインストールを行うようにしてください。**

## 「モデムモード」の注意点

### ファイアーウォール

「モデムモード」でインストールすると、`ufw`のパッケージもインストールされます。このインストーラーでは、以下のような初期設定を行いデフォルトで`ufw`を **有効** にします(`ufw enable`)。

    (rpi) $ sudo ufw deny in on ppp0
    (rpi) $ sudo ufw allow in on eth0
    (rpi) $ sudo ufw allow in on wlan0 # 無線LANがある場合

つまり、ppp側のポートは最初は解放されていません。必要に応じて、利用するポートの設定を行ってください。インストール時に、`wlan1`など上記以外のネットワークインタフェースが有効である場合は、そのインタフェースについても上記のように設定されます。

もし`ufw`がすでにインストールされている場合は、上記の設定を行わず、`ufw`の動作状態も変更しません（`ufw`が無効となっていれば無効なままとなる）。

### ppp設定

「モデムモード」では、LTE接続時にpppと呼ばれる方式で接続します。この方式では、インターネット接続の管理をLinux側で行います。例えば、pppオプションに`persist`を設定すると、網側から接続を切断されたとしても、自動的に再接続を行うようになります。また、別のオプションとしては`demand`があります。この場合は、ラズパイ側でインターネットへのアクセスが発生すると、網側への接続を自動的に行うような動作をします。

なお、インストール時には、「`persist`」が指定されています。

網側の接続中の振る舞いは、MVNO事業者や契約プランによっても変わる場合があります。網側の接続中の振る舞いというのは、例えば、一定時間無通信の場合は切断するというものです。通常それらの情報は開示されておりません。したがって、「モデムモード」でお使いになる場合は、実際に接続時の振る舞いを見た上で、pppの設定を変更する必要があります。

pppの細かい設定については、こちらでは記載しておりませんので、インターネット等で参照してください。

### ppp接続と切断方法

接続には、`sudo pon ltepi2`を、切断には`sudo poff`を実行してください。APNの設定は、pppconfigでは行いません（pppconfigで設定をしても無視されます）。APNについては「[インストール後の作業](インストール後の作業.md)」を参照してください。

また、「モデムモード」でLTE接続を行う場合、ltepi2-serviceが起動している必要があります。これは、ltepi2-serviceがモデムの電源を入れるなどの初期設定を行っているためです。ltepi2-serviceの起動状態については`systemctl status ltepi2`を実行して確認してください。

なお、ラズパイ起動時には、自動的にLTE通信を開始するコマンド（`sudo pon ltepi2`）を実行します。もし、接続されていない場合は、`/var/log/syslog`の内容を確認して対処してください。

**注意：ppp接続を切断しても、LTE/3Gネットワークとの回線接続がすぐに切断されるわけではありません。ネットワーク側の判断により接続が維持されたり、切断されることがあります。常に回線が切断されるという保証はありません。**

## LTE経由で外部からアクセスできるようにするには

LTE経由で外部からアクセスできるようにするには以下の2種類の条件を満たす必要があります。

- SIMの条件
- 名前解決の条件

### SIMの条件

[LTEPi for D](https://www.candy-line.io/製品一覧/ltepi-for-d/)でLTE回線でインターネットにアクセスするときに、ラズパイにIPアドレスがMVNOの網側から割り当てられます。このアドレスが外部からアクセス可能なパブリックIP（グローバルIP）でなければ、インターネット経由でラズパイに到達できません。ご契約のSIMを利用した場合、パブリックIP（グローバルIP）が割り当てられるかどうかについて、あらかじめご契約先に確認してください。

### 名前解決の条件

ラズパイにLTE回線経由で接続するとき、接続元は、ラズパイに割り当たっているIPアドレスが何であるかあらかじめ把握している必要があります。これを実現する方法としては、次の2種類があります。

- Dynamic DNSサービスを使う
- 固定IPアドレスを使う

前者については、関連する情報がインターネット上にありますので、そちらを参照してください。
また、後者についても、MVNO事業者によっては取り扱いがあるところもありますので、条件に合う事業者をお探しください。

### 一時的なアクセス

一時的にラズパイへアクセスする場合であれば、ラズパイ上でパブリックIP（グローバルIP）を確認して、そのアドレスで別の機器から接続を行うこともできます。

    (rpi) $ ifconfig ppp0
    (rpi) ppp0      Link encap:Point-to-Point Protocol  
    (rpi)           inet addr:xxx.xxx.xxx.xxx  P-t-P:10.64.64.64  Mask:255.255.255.255
    (rpi)           UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
    (rpi)           RX packets:10566 errors:0 dropped:0 overruns:0 frame:0
    (rpi)           TX packets:12116 errors:0 dropped:0 overruns:0 carrier:0
    (rpi)           collisions:0 txqueuelen:3
    (rpi)           RX bytes:881838 (861.1 KiB)  TX bytes:1026635 (1002.5 KiB)

ここで、`inet addr`のアドレス(`xxx.xxx.xxx.xxx`となっている箇所)が外部からアクセスできるパブリックIP（グローバルIP）となります。

### 「モデムモード」以外の代替案

「ルーターモード」であっても、[`ngrok`](https://ngrok.com)を利用すれば、ラズパイの特定のポートを外部に公開することができます。ただし、この方式では、海外のサーバーを経由するので、遅延やあるいは、そのサーバーがダウンすることによって不通となる場合もあります。ご興味があれば、お試しください。

## 「モデムモード」から「ルーターモード」に変更するには

モードの変更を行うためには、[ltepi2-serviceのアンインストール](アンインストール方法.md)を行ってから、再度「[インストール方法](インストール方法.md)」にしたがってインストールしてください。

ただし、[ltepi2-serviceのアンインストール](アンインストール方法.md)を行っても、以下のパッケージは削除されません。

- `ufw` ... ファイアーウォール
- `ppp` ... ppp関連
- `pppconfig` ... ppp設定ツール

また、ファイアーウォールは有効なままになっていますので、不要な場合は、以下のコマンドで起動しないようにします。

    (rpi) $sudo ufw disable

実行すると、確認を求められますが、有線LANまたはWi-Fiで接続している場合は、`y`を選択して構いません。

---

続いて「[インストール後の作業](インストール後の作業.md)」をご覧ください。

* [インストール前に準備するもの](インストール前に準備するもの.md)
* [インストール方法](インストール方法.md)
* [インストール後の作業](インストール後の作業.md)
* [ltepi2-serviceの起動と停止](ltepi2-serviceの起動と停止.md)
* [CANDY-REDへのブラウザー接続](CANDY-REDへのブラウザー接続.md)
* [CANDY REDのインストール方法](CANDY-REDのインストール方法.md)
* [うまく動かない時は](うまく動かない時は.md)

---
© 2017 CANDY LINE, INC. [CC-BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)
