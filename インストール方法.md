[🔙目次ページへ戻る](README.md)

# LTEPi for Dのセットアップ (ltepi2-serviceのインストール)

最初にLANケーブルの一方をRaspberry Piに、もう一方をブロードバンドルーターに接続してインターネットに通信できる状態にしてください。電源はこの時点ではまだ入れないでください。

すでにRaspberry PiにてWi-Fiの設定を行っており、インターネットを利用できている場合は、Wi-Fi経由でこれ以降の作業を行うことも可能です。

次に、[LTEPi for D](http://www.candy-line.io/proandsv.html#ltepiford)をRaspberry Piに設置します。また、付属のアンテナを2本ともモジュールに接続します。続けて、SIMカードを差し込みます。SIMカードは、金属面を下向きにして取り付けます。

最後に、付属のUSBケーブルで[LTEPi for D](http://www.candy-line.io/proandsv.html#ltepiford)とRaspberry Piを接続します。

これで準備が整いました。それでは、Raspberry Piの電源用USBケーブルを接続してRaspberry Piを起動させましょう。

Raspberry Piが起動したら、試しに以下のようなcURLコマンドを実行してみましょう。

```bash
$ curl -i -L --head http://www.candy-line.io/
```

下記のように`HTTP/1.1 200 OK`と出ていれば問題ありません。
```bash
HTTP/1.1 200 OK
Server: nginx
Date: Sat, 23 Jul 2016 03:26:46 GMT
Content-Type: text/html
Content-Length: 16236
Connection: keep-alive
X-Accel-Version: 0.01
Last-Modified: Wed, 11 May 2016 01:37:07 GMT
ETag: "3f6c-532871464597b"
Accept-Ranges: bytes
Vary: Accept-Encoding
```

続いてOSの状態が古い場合は、必要に応じて新しい状態に更新しましょう。
もしこのタイミングで更新したくなければ、この手順を飛ばしても構いません。
ただし、あまりにも古いOSであれば動作しない可能性もありますので、その場合は更新することを検討してください。
```bash
$ sudo apt-get upgrade -y
```
なお、この処理には、SDカードのクラス(読み書き速度)、更新するデータ量、あるいはネットワーク環境によりますが30分〜1時間以上かかることがあります。

それでは、GitHub上にあるスクリプトをダウンロードしてインストールします。

以下のコマンドを実行します（`git.io`もGitHubの管理するドメインの1つです）。

**注意：以下のコマンドは、プリインストールされているNode-REDを削除し、[CANDY RED](https://github.com/dbaba/candy-red)に置き換えます（Node-REDと同じ使い方をすることができますのでNode-REDの代わりとしてお使いいただけます）。Node.jsを更新するため、プリインストールされているNode-REDを残しておくことができないので削除しています。**

**注意：古いバージョンのUIライブラリーであるnode-red-contrib-uiをお使いの方は、[CANDY RED](https://github.com/dbaba/candy-red)をインストールしないようにしてください。node-red-contrib-uiは、[CANDY RED](https://github.com/dbaba/candy-red)に含まれているNode-REDのバージョンと整合性が取れませんので動作しなくなるためです**

```bash
$ curl -L https://git.io/vKyOf | sudo bash
```

[CANDY RED](https://github.com/dbaba/candy-red)を **インストールしない場合** は、以下のように`CANDY_RED=0`を指定します。
```bash
$ curl -L https://git.io/vKyOf | sudo CANDY_RED=0 bash
```

また、特定のバージョンを利用する場合は、以下のようにバージョンを指定することができます。
```bash
$ VERSION=1.2.3 && \
  curl -L https://raw.githubusercontent.com/CANDY-LINE/ltepi2-service/${VERSION}/install.sh | \
  sudo bash
```

実行すると以下のように表示されます。

    [INFO] Installing command lines to /opt/candy-line/ltepi2/bin...
              :
              :
    [INFO] Installing CANDY RED...
              :
              :
    [INFO] ltepi2 service has been installed
    [ALERT] *** Please reboot the system (enter 'sudo reboot') ***

なおインストールには時間がかかります。状況によっては1~2時間以上かかりますので、処理が止まっているように見えても途中で中断をしないようにしてください。

## インストール後の作業
インストールした後は、以下のコマンドを実行して再起動させましょう。

```bash
$ sudo reboot
```

再起動後しばらくすると、[LTEPi for D](http://www.candy-line.io/proandsv.html#ltepiford)のLEDにある2つのLEDのうち1つがオレンジ色で常時点灯となり、もう一つが点滅します。これはモデムが起動していることを表しています。

[LTEPi for D](http://www.candy-line.io/proandsv.html#ltepiford)のLEDが点滅していれば、セットアップは完了です！

[CANDY-REDへのブラウザー接続](CANDY-REDへのブラウザー接続.md)のページを参照して、[CANDY RED](https://github.com/dbaba/candy-red)を動かしてみましょう。
あるいは、すでにRaspberry Piで動作するアプリケーションをお持ちの場合は、動かしてみましょう。

もし圏外だったり、アンテナが接続されていなかったりした場合は、モデムは起動できません。LEDの表示はオレンジ色の1つのみ点灯します。
[うまく動かない時は](うまく動かない時は.md)のページ　にモデムが起動しない場合の対処策をまとめていますので、ご確認ください。

また、既定の設定では、U-mobileのAPN設定が反映されます。このため、お使いのSIMカードがU-mobile以外のものである場合は、以下の方法で変更する必要があります。

### APN設定（コマンドライン）

```bash
$ sudo candy apn set -n APN名 -u APNユーザーID -p APNパスワード
```

実行後、登録されているかどうかを以下のコマンドで確認することができます。
```bash
$ sudo candy apn ls
{
  "apns": [
    {
      "apn": "APN名",
      "user": "APNユーザーID",
      "apn_id": "1"
    }
  ]
}
```

なお、パスワードは表示されません。

設定変更を確認したら、再起動を行ってください。再起動すると変更したAPNを利用できるようになります。

```bash
$ sudo reboot
```

APN設定方法には、他にファイルを使用した方法もあります。以下にファイルによる変更方法を記します。

### APN設定（ファイル）

コマンドによるAPN設定のほか、あらかじめJSONファイルにAPNを書いておき、それを読み込ませる方法によってAPN設定を変更することもできます。

まずは以下のようなJSONファイルを作成します。ファイル名は、`boot-apn.json`とし、`/opt/candy-line/ltepi2`ディレクトリーに保存します。
```
{"apn":"APN名","user":"APNユーザーID","password":"APNパスワード"}
```
[こちら](systemd/boot-apn.json)に実際のファイルがあります。

ファイルを作成後、再起動を行ってください。再起動すると変更したAPNを利用できるようになります。ただし、再起動後は`boot-apn.json`が削除されます。これは、コマンドラインによるAPN設定変更が常に上書きされないようにするためです。

* [インストール前に準備するもの](インストール前に準備するもの.md)
* [ltepi2-serviceの起動と停止](ltepi2-serviceの起動と停止.md)
* [CANDY-REDへのブラウザー接続](CANDY-REDへのブラウザー接続.md)
* [CANDY REDのインストール方法](CANDY-REDのインストール方法.md)
* [うまく動かない時は](うまく動かない時は.md)

---
COPYRIGHT © 2016 CANDY LINE, Inc. [CC-BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)
